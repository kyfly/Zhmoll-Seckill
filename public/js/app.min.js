function initContent(t,e){t.title=e.title,t.startAt=e.startAt,t.logoUrl=e.logoUrl,t.description=e.description,t.totalAwardCount=0,t.content.splice(0,t.content.length),e.content.forEach(function(e){t.content.push(e),t.totalAwardCount+=e.limit})}function initCountdown(t){$(".countdown").downCount({date:t,offset:8},function(){})}function login_succeed(t){vm.token=t,socket=function(){var t=io("/seckill",{reconnectionAttempts:1,autoConnect:!1,query:"seckillid="+vm.seckillid+"&token="+vm.token});return t.on("connect",function(){vm.isLogin=!0,emitToastr("登陆成功","success"),localStorage[vm.seckillid+vm.field_uid]&&""!=localStorage[vm.seckillid+vm.field_uid]&&(vm.awardname=localStorage[vm.seckillid+vm.field_uid])}),t.on("succeed",function(t){emitToastr("恭喜你抢到["+t+"]啦!","success"),localStorage[vm.seckillid+vm.field_uid]=vm.awardname=t,vm.rest_count>0&&vm.rest_count--}),t.on("failure",function(t){switch(t){case"notyet":emitToastr("秒杀还没开始!");break;case"awarded":emitToastr("你已经抢到["+vm.awardname+"]了!");break;case"finished":emitToastr("票已经被抢完啦!");break;case"again":emitToastr("差一点点就抢到啦!再继续试试!")}}),t.on("message",function(t){t.t&&(countDown=t.t-Date.now(),serverStart=new Date(vm.seckill.startAt).getTime(),initCountdown(vm.seckill.startAt)),t.e&&emitToastr(t.e,"error"),void 0!==t.r&&(vm.rest_count=t.r),void 0!==t.h&&(vm.online_count=t.h),t.m&&emitToastr(t.m)}),t.on("disconnect",function(){vm.isLogin=!1,emitToastr("与服务器连接中断")}),t.on("connect_error",function(t){emitToastr("服务器拒绝连接","error")}),t.open(),t}()}function emitToastr(t,e){e=e||"info",toastr[e](t);const o={time:new Date,seckillid:vm.seckillid,token:vm.token,message:t,type:e};vm.log_box.unshift(o),localStorage.log_box=JSON.stringify(vm.log_box),console.log(JSON.stringify(o))}var socket,countDown=0,serverStart=0,login_click_mutex=!1,lastCommit=Date.now(),vm=new Vue({el:"#app",data:{seckillid:"",gotSeckill:!1,seckill:{title:"团团一家秒杀活动",description:"",startAt:"",logoUrl:"",content:[],totalAwardCount:0},field_uid:localStorage.uid||"",field_name:localStorage.name||"",isLogin:!1,online_count:0,rest_count:0,awardname:"",log_box:localStorage.info_box&&JSON.parse(localStorage.info_box)||[]},mounted:function(){toastr.options.newestOnTop=!1,toastr.options.timeOut=20;var t=window.location.pathname.split("/")[2];if(this.seckillid=t,localStorage[t]){var e=JSON.parse(localStorage[t]);initContent(this.seckill,e)}axios.get("/api/seckill/"+t).then(function(e){var o=e.data;if(4101!=o.code)throw new Error("获取秒杀活动失败");initContent(vm.seckill,o.body),vm.gotSeckill=!0,localStorage[t]=null,localStorage[t]=JSON.stringify(vm.seckill)}).catch(function(t){emitToastr(t.message,"error")})},methods:{login:function(){if(!login_click_mutex){login_click_mutex=!0;var t=this.seckillid;localStorage.uid=this.field_uid,localStorage.name=this.field_name,axios.post("/api/seckill/"+t+"/join",{uid:this.field_uid,name:this.field_name}).then(function(t){var e=t.data;switch(e.code){case 4e3:login_succeed(e.body.token);break;case 4001:emitToastr("登录失败，学号／工号不存在。","error");break;case 4002:emitToastr("登录失败，请核对学号／工号与姓名是否匹配。","error");break;case 4003:emitToastr("登录失败，请在活动开始前30分钟内再来登录。","error");break;case 4004:emitToastr("登录失败，本次活动已经结束。","error");break;case 4102:emitToastr("登录失败，找不到该秒杀活动。","error");break;default:emitToastr("登录失败","error")}login_click_mutex=!1}).catch(function(t){console.error(t),login_click_mutex=!1})}},kill:function(){var t=Date.now(),e=t+countDown;if(0!==serverStart)return e-serverStart>-1e3?void(t-lastCommit>140&&(socket.emit("submitkill"),lastCommit=t)):void emitToastr("秒杀还没开始!")}}});