function initContent(t,e){t.title=e.title,t.startAt=e.startAt,t.logoUrl=e.logoUrl,t.description=e.description,t.totalAwardCount=0,t.content.splice(0,t.content.length),e.content.forEach(function(e){t.content.push(e),t.totalAwardCount+=e.limit})}function initCountdown(t){countdown_timer&&clearInterval(countdown_timer),countdown_timer=setInterval(function(){var e=new Date(t),o=new Date,i=e-o;if(i<0)return void clearInterval(countdown_timer);var n=Math.floor(i/864e5),r=Math.floor(i%864e5/36e5),a=Math.floor(i%36e5/6e4),c=Math.floor(i%6e4/1e3);n=String(n).length>=2?n:"0"+n,r=String(r).length>=2?r:"0"+r,a=String(a).length>=2?a:"0"+a,c=String(c).length>=2?c:"0"+c;var l=1===n?"day":"days",s=1===r?"hour":"hours",m=1===a?"minute":"minutes",d=1===c?"second":"seconds",u=$(".countdown");u.find(".days").text(n),u.find(".hours").text(r),u.find(".minutes").text(a),u.find(".seconds").text(c),u.find(".days_ref").text(l),u.find(".hours_ref").text(s),u.find(".minutes_ref").text(m),u.find(".seconds_ref").text(d)},222)}function login_succeed(t){vm.token=t,socket=function(){var t=io("/seckill",{reconnectionAttempts:1,autoConnect:!1,query:"seckillid="+vm.seckillid+"&token="+vm.token});return t.on("connect",function(){vm.isLogin=!0,emitToastr("登陆成功","success"),localStorage[vm.seckillid+vm.field_uid]&&""!=localStorage[vm.seckillid+vm.field_uid]&&(vm.awardname=localStorage[vm.seckillid+vm.field_uid])}),t.on("succeed",function(t){emitToastr("恭喜你抢到["+t+"]啦!","success"),localStorage[vm.seckillid+vm.field_uid]=vm.awardname=t,vm.rest_count>0&&vm.rest_count--}),t.on("failure",function(t){switch(t){case"notyet":emitToastr("活动还没开始!");break;case"awarded":emitToastr("已经抢到过啦，是["+vm.awardname+"]!");break;case"finished":emitToastr("票已经被抢完啦!");break;case"again":emitToastr("差一点点就抢到啦!再继续试试!");break;case"cheated":emitToastr("检测到你作弊啦!")}}),t.on("message",function(t){if(t.t){var e=Date.now(),o=t.t-e;(!time_difference||o>time_difference)&&(time_difference=o,initCountdown(new Date(serverStart-time_difference)))}t.e&&emitToastr(t.e,"error"),void 0!==t.r&&(vm.rest_count=t.r),void 0!==t.h&&(vm.online_count=t.h),t.m&&emitToastr(t.m)}),t.on("disconnect",function(){vm.isLogin=!1,emitToastr("服务器连接中断")}),t.on("connect_error",function(t){emitToastr("服务器拒绝连接","error")}),t.open(),t}()}function emitToastr(t,e){e=e||"info",toastr[e](t);const o={time:new Date,seckillid:vm.seckillid,token:vm.token,message:t,type:e};vm.log_box.unshift(o),localStorage.log_box=JSON.stringify(vm.log_box),console.log(JSON.stringify(o))}var socket,time_difference,serverStart=0,login_click_mutex=!1,countdown_timer,vm=new Vue({el:"#app",data:{seckillid:"",gotSeckill:!1,seckill:{title:"团团一家秒杀活动",description:"",startAt:"",logoUrl:"",content:[],totalAwardCount:0},field_uid:localStorage.uid||"",field_name:localStorage.name||"",isLogin:!1,online_count:0,rest_count:0,awardname:"",lastCommit:Date.now(),log_box:localStorage.info_box&&JSON.parse(localStorage.info_box)||[]},mounted:function(){toastr.options.newestOnTop=!1,toastr.options.timeOut=20;var t=window.location.pathname.split("/")[2];if(this.seckillid=t,localStorage[t]){var e=JSON.parse(localStorage[t]);initContent(this.seckill,e)}axios.get("/api/seckill/"+t).then(function(e){var o=e.data;if(4101!=o.code)throw new Error("获取秒杀活动失败");initContent(vm.seckill,o.body),serverStart=new Date(vm.seckill.startAt).getTime(),vm.gotSeckill=!0,localStorage[t]=null,localStorage[t]=JSON.stringify(vm.seckill)}).catch(function(t){emitToastr(t.message,"error")})},methods:{login:function(){if(!login_click_mutex){login_click_mutex=!0;var t=this.seckillid;localStorage.uid=this.field_uid,localStorage.name=this.field_name,axios.post("/api/seckill/"+t+"/join",{uid:this.field_uid,name:this.field_name}).then(function(t){var e=t.data;switch(e.code){case 4e3:login_succeed(e.body.token);break;case 4001:emitToastr("登录失败，学号／工号不存在。","error");break;case 4002:emitToastr("登录失败，请核对学号／工号与姓名是否匹配。","error");break;case 4003:emitToastr("登录失败，请在活动开始前30分钟内再来登录。","error");break;case 4004:emitToastr("登录失败，本次活动已经结束。","error");break;case 4102:emitToastr("登录失败，找不到该秒杀活动。","error");break;default:emitToastr("登录失败","error")}login_click_mutex=!1}).catch(function(t){console.error(t),login_click_mutex=!1})}},kill:function(){var t=Date.now(),e=t+time_difference;if(0!==serverStart)return e-serverStart>-1e3?void(t-vm.lastCommit>140&&(socket.emit("submitkill"),vm.lastCommit=t)):void emitToastr("活动还没开始!")}}});